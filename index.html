<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>RubyQuize 2024</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link rel="icon" href="favicon.ico">
  <script type="module" src="https://getty104.github.io/ruby-wasm-vdom/index.js"></script>
</head>
<body>
  <h1>RubyQuize 2024</h1>
  <div id="app"></div>

  <script type="text/ruby">
    # 要件
    # 25 件の問題から 5 つをランダムで選んで出題
    # 1 つの問題には 4 つの選択肢があり、正解は一つ
    # 回答を選択すると、正解・不正解が表示されて次の問題に移る
    # 5 問解答が終わると結果画面が表示されて、正答数と各問題の解説が表示される
    # reset を実行すると、最初に戻る
    require "js"

    puts RUBY_VERSION

    QUESTIONS = [
      { title: '問題1', description: 'これはどれ？', choices: ['hoge', 'piyo', 'fuga', 'foo'], answerIndex: 0, explanation: '解説' },
      { title: '問題2', description: 'これはどれでしょう？', choices: ['hoge2', 'piyo2', 'fuga2', 'foo2'], answerIndex: 1, explanation: '解説2' },
      { title: '問題3', description: 'これはどれだ？', choices: ['hoge3', 'piyo3', 'fuga3', 'foo3'], answerIndex: 2, explanation: '解説3' },
      { title: '問題4', description: 'これはどれかな？', choices: ['hoge4', 'piyo4', 'fuga4', 'foo4'], answerIndex: 3, explanation: '解説4' },
      { title: '問題5', description: 'これはどれ？', choices: ['hoge5', 'piyo5', 'fuga5', 'foo5'], answerIndex: 0, explanation: '解説5' },
      { title: '問題6', description: 'これはどれ？', choices: ['hoge6', 'piyo6', 'fuga6', 'foo6'], answerIndex: 1, explanation: '解説6' },
      { title: '問題7', description: 'これはどれ？', choices: ['hoge', 'piyo', 'fuga', 'foo'], answerIndex: 0, explanation: '解説7' },
      { title: '問題8', description: 'これはどれでしょう？', choices: ['hoge2', 'piyo2', 'fuga2', 'foo2'], answerIndex: 1, explanation: '解説8' },
      { title: '問題9', description: 'これはどれだ？', choices: ['hoge3', 'piyo3', 'fuga3', 'foo3'], answerIndex: 2, explanation: '解説9' },
      { title: '問題10', description: 'これはどれかな？', choices: ['hoge4', 'piyo4', 'fuga4', 'foo4'], answerIndex: 3, explanation: '解説10' },
      { title: '問題11', description: 'これはどれ？', choices: ['hoge5', 'piyo5', 'fuga5', 'foo5'], answerIndex: 0, explanation: '解説11' },
      { title: '問題12', description: 'これはどれ？', choices: ['hoge6', 'piyo6', 'fuga6', 'foo6'], answerIndex: 1, explanation: '解説12' },
      { title: '問題13', description: 'これはどれ？', choices: ['hoge', 'piyo', 'fuga', 'foo'], answerIndex: 0, explanation: '解説13' },
      { title: '問題14', description: 'これはどれでしょう？', choices: ['hoge2', 'piyo2', 'fuga2', 'foo2'], answerIndex: 1, explanation: '解説14' },
      { title: '問題15', description: 'これはどれだ？', choices: ['hoge3', 'piyo3', 'fuga3', 'foo3'], answerIndex: 2, explanation: '解説15' },
      { title: '問題16', description: 'これはどれかな？', choices: ['hoge4', 'piyo4', 'fuga4', 'foo4'], answerIndex: 3, explanation: '解説16' },
      { title: '問題17', description: 'これはどれ？', choices: ['hoge5', 'piyo5', 'fuga5', 'foo5'], answerIndex: 0, explanation: '解説17' },
      { title: '問題18', description: 'これはどれ？', choices: ['hoge6', 'piyo6', 'fuga6', 'foo6'], answerIndex: 1, explanation: '解説18' },
      { title: '問題19', description: 'これはどれ？', choices: ['hoge', 'piyo', 'fuga', 'foo'], answerIndex: 0, explanation: '解説19' },
    ]

    def renderApp(state:, view:, actions:)
      appEl = JS.global[:document].getElementById('app');
      children = appEl[:children]

      # 既存の view があれば非表示にする。(要素自体を消すと RubyWasmVdom::App のエラーが出るので非表示で誤魔化す)
      if children[:length].to_i > 0
        children[0][:style][:display] = 'none'
      end

      RubyWasmVdom::App.new(
        el: "#app",
        state:,
        view:,
        actions:
      )
    end

    def initialize
      state = {
        questions: QUESTIONS.shuffle[0..][0..5],
        questionIndex: 0,
        correctAnswerCount: 0,
        lastQuestionResult: ''
      }

      # 結果画面用の View
      resultView = ->(state, actions) {
        eval RubyWasmVdom::DomParser.parse(<<-DOM)
          <div>
            <h2>結果</h2>
            <p>{"結果は 5 問中 #{state[:correctAnswerCount]} 問正解！"}</p>

            <h2>解説</h2>
            <p>{"問題 1: #{state[:questions][0][:explanation]}"}</p>
            <p>{"問題 2: #{state[:questions][1][:explanation]}"}</p>
            <p>{"問題 3: #{state[:questions][2][:explanation]}"}</p>
            <p>{"問題 4: #{state[:questions][3][:explanation]}"}</p>
            <p>{"問題 5: #{state[:questions][4][:explanation]}"}</p>

            <button onclick='{->(e) { actions[:reset].call(0, 0) } }'>リセット</button>
          </div>
        DOM
      }

      # 初期表示 View
      initialView = ->(state, actions) {
        eval RubyWasmVdom::DomParser.parse(<<-DOM)
          <div>
            <h2>問題</h2>

            <p>{"第 #{state[:questions].index(state[:questions][state[:questionIndex]]) + 1} 問: #{state[:questions][state[:questionIndex]][:description]}"}</p>

            <button onclick='{->(e) { actions[:selectChoice].call(state[:questions][state[:questionIndex]], 0) } }'>{state[:questions][state[:questionIndex]][:choices][0]}</button>
            <button onclick='{->(e) { actions[:selectChoice].call(state[:questions][state[:questionIndex]], 1) } }'>{state[:questions][state[:questionIndex]][:choices][1]}</button>
            <button onclick='{->(e) { actions[:selectChoice].call(state[:questions][state[:questionIndex]], 2) } }'>{state[:questions][state[:questionIndex]][:choices][2]}</button>
            <button onclick='{->(e) { actions[:selectChoice].call(state[:questions][state[:questionIndex]], 3) } }'>{state[:questions][state[:questionIndex]][:choices][3]}</button>

            <p>{"前の問題の結果は: #{state[:lastQuestionResult]}"}</p>
          </div>
        DOM
      }

      actions = {
        selectChoice: ->(question, choiceIndex) {
          state[:questionIndex] += 1
          if question[:answerIndex] == choiceIndex
            state[:correctAnswerCount] += 1
            state[:lastQuestionResult] = '正解 :)'
          else
            state[:lastQuestionResult] = '不正解 :('
          end

          if state[:questionIndex] == 5
            renderApp(state: state, view: resultView, actions: actions)
          end
        },

        # actions 内で引数の数を合わせないとバグるので無理やり合わせる
        reset: ->(_a, _b) {
          JS.global[:window][:location].reload();
        }
      }

      renderApp(state: state, view: initialView, actions: actions)
    end

    initialize()
  </script>
</body>
</html>
